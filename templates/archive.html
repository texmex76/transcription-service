{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="left-panel">
        <p>
            <a href="{{ url_for('index') }}" style="text-decoration:none; color:#FF9800; font-weight:bold;">
                Back to Home
            </a>
        </p>
        <div class="task-list">
            {% if tasks %}
                {% for task in tasks %}
                <div class="task">
                    <h2>{{ task }}</h2>
                    <div class="download-links">
                        {% if 'output.txt' in tasks[task] %}
                        <a href="#" onclick="showFile('{{task}}','output.txt')">TXT</a>
                        {% endif %}
                        {% if 'output.srt' in tasks[task] %}
                        <a href="#" onclick="showFile('{{task}}','output.srt')">SRT</a>
                        {% endif %}
                        {% if 'stdout.log' in tasks[task] %}
                        <a href="#" onclick="showFile('{{task}}','stdout.log')">Stdout</a>
                        {% endif %}
                    </div>
                    <form method="POST" action="{{ url_for('delete_task', task_id=task) }}" style="margin-top:10px;">
                        <button class="button" type="submit">Delete</button>
                    </form>
                </div>
                {% endfor %}
            {% else %}
                <p>No archived transcriptions found.</p>
            {% endif %}
        </div>
    </div>

    <div class="right-panel-container">
        <div class="preview-header">
            <span id="file-name-display">Select a file to view.</span>
            <button id="download-button" class="button" style="display:none;">Download</button>
        </div>
        <div id="file-content">
            Select a file on the left to view its contents here.
        </div>
    </div>
</div>

<script>
let currentTaskId = null;
let currentFileName = null;

async function showFile(task_id, filename) {
    const contentDiv = document.getElementById('file-content');
    const fileNameDisplay = document.getElementById('file-name-display');
    const downloadButton = document.getElementById('download-button');

    currentTaskId = task_id;
    currentFileName = filename;

    fileNameDisplay.textContent = `Viewing: ${filename}`;
    downloadButton.style.display = 'inline-block';
    downloadButton.onclick = () => {
        window.location.href = `/download/${task_id}/${filename}`;
    };

    contentDiv.textContent = "Loading...";
    try {
        let response = await fetch(`/view/${task_id}/${filename}`);
        if (response.ok) {
            let text = await response.text();
            // Wrap in a <pre> for preserving whitespace and newlines
            contentDiv.innerHTML = "<pre>" + escapeHTML(text) + "</pre>";
        } else {
            contentDiv.textContent = "Failed to load file.";
        }
    } catch (e) {
        contentDiv.textContent = "Error loading file.";
    }
}

function escapeHTML(str) {
    return str.replace(/[&<>"'`=\/]/g, function (s) {
      var entityMap = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
        '/': '&#x2F;'
      };
      return entityMap[s];
    });
}
</script>
{% endblock %}

